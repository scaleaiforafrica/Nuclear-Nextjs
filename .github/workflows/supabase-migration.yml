name: Supabase Database Migration

on:
  pull_request:
    branches:
      - main
    paths:
      - 'migrations/**'
      - 'schema.sql'
      - 'full_db_setup.sql'
      - 'reset_and_setup_db.sql'
      - 'seed.sql'

jobs:
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase Project
        run: |
          supabase link --project-ref $SUPABASE_PROJECT_ID

      - name: Get changed migration files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            migrations/**/*.sql
            schema.sql
            full_db_setup.sql

      - name: Run migrations
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          
          # Push database changes using Supabase CLI
          supabase db push

      - name: Validate database schema
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Database migrations applied successfully"
          # Optionally run schema validation
          supabase db lint
